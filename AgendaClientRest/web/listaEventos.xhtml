<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <h:head>
        <title>Lista de eventos</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta charset="utf-8"></meta>
        <style>
           #map {
                  height: 300px;
                  width: 80%;
                }
        </style>
        <script>
            var latEvents=new Array();
            var longEvents=new Array();
        </script>
       
    </h:head>
    <h:body>
        <h:form>    
        <h:commandButton id="Salir" value="Salir" action="#{agendaRestManagedBean.salir()}" />
        <br/>  
            <h:commandButton id="VerPerfil" value="Ver Perfil" action="#{agendaRestManagedBean.verPerfil()}" rendered="#{agendaRestManagedBean.usuarioSeleccionado != null}"/>
        <br/>
        </h:form>   
        <br/>
        <h:form id="busqueda">
                
            <h:selectOneRadio value="#{agendaRestManagedBean.busquedad}"  rendered="#{agendaRestManagedBean.usuarioSeleccionado != null}">
                       <f:selectItem itemValue="1" itemLabel="Buscar por fecha"/> <br/>
                       <f:selectItem itemValue="2" itemLabel="Buscar por código postal" /><br/>
                       <f:selectItem itemValue="3" itemLabel="Buscar por preferencias" />
                    </h:selectOneRadio>
            <h:selectOneRadio value="#{agendaRestManagedBean.busquedad}"  rendered="#{agendaRestManagedBean.usuarioSeleccionado == null}">
                       <f:selectItem itemValue="1" itemLabel="Buscar por fecha"/> <br/>
                       <f:selectItem itemValue="2" itemLabel="Buscar por código postal" /><br/>
                       <f:selectItem itemValue="3" itemLabel="Ver todos los eventos" /><br/>
                    </h:selectOneRadio>
                <div id="fechaBusqueda" >
                    <h:outputLabel value="Fecha:" for="fecha" />
                    <h:inputText id="fechaBusqueda" value="#{agendaRestManagedBean.fechaOrdenacion}" title="Fecha" >
                        <f:convertDateTime pattern="dd/MM/yyyy" />
                    </h:inputText>
                 </div>
                 <div id="cpBusqueda">
                     <h:outputLabel value="Codigo Postal:" for="cp" />
                     <h:inputText id="cpBusqueda" value="#{agendaRestManagedBean.distanciaKm}" title="cp" />
                 </div>
            <h:commandButton value="Buscar" onclick="#{agendaRestManagedBean.buscarPor()}">
                </h:commandButton>
             </h:form> 
        <br/>
        <h:form id="ordenacion">
            <h:selectOneRadio value="#{agendaRestManagedBean.ordenacion}">
                   <f:selectItem itemValue="1" itemLabel="Ordenar por precio" /><br/>
                   <f:selectItem itemValue="2" itemLabel="Ordenar por fecha" /><br/>
                   <f:selectItem itemValue="3" itemLabel="Ordenar por localización" /><br/>
                   <f:selectItem itemValue="4" itemLabel="Sin ordenar" /><br/>
                   <f:ajax execute="@form" listener="#{agendaRestManagedBean.ordenar()}" />
                </h:selectOneRadio>
                 <h:commandButton value="Ordenar">
                    <f:ajax execute="@form" render="listaEventos" />
                </h:commandButton> 
             </h:form>

        <br/>
        <f:view>
            <h:form id="listaEventos">
                <h1><h:outputText value="List"/></h1>
                <h:dataTable value="#{agendaRestManagedBean.listaEventos}" var="item">
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Fechainicio"/>
                        </f:facet>
                        <h:outputText value="#{item.fechainicio}">
                            <f:convertDateTime pattern="MM/dd/yyyy" />
                        </h:outputText>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Fechafin"/>
                        </f:facet>
                        <h:outputText value="#{item.fechafin}">
                            <f:convertDateTime pattern="MM/dd/yyyy" />
                        </h:outputText>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Descripcion"/>
                        </f:facet>
                        <h:outputText value="#{item.descripcion}"/>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Localizacion"/>
                        </f:facet>
                        <h:outputText value="#{item.localizacion}"/>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Precio"/>
                        </f:facet>
                        <h:outputText value="#{item.precio}"/>
                    </h:column>
                    
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Latitud"/>
                        </f:facet>
                        <h:outputText class="latitud" value="#{item.latitud}"/>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="longitud"/>
                        </f:facet>
                        <h:outputText class="longitud" value="#{item.longitud}"/>
                    </h:column>
                    <h:column>
                        <h:commandButton id="VerEvento" value="VerEvento" action="#{agendaRestManagedBean.verEvento(item)}" />
                    </h:column>
                    <h:column>
                        
                        <h:commandButton id="Modificar" value="Modificar" action="#{agendaRestManagedBean.modificarEvento(item)}" rendered="#{agendaRestManagedBean.usuarioSeleccionado.tipoUsuario == 3}" />
                    </h:column>
                    <h:column>
                        
                        <h:commandButton id="Eliminar" value="Eliminar" action="#{agendaRestManagedBean.eliminarEvento(item)}" rendered="#{agendaRestManagedBean.usuarioSeleccionado.tipoUsuario == 3}">
                            <f:ajax execute="@form" render="listaEventos"/>
                        </h:commandButton>
                    </h:column>
                    
                </h:dataTable>
                
                <h:commandButton id="CrearEvento" value="Crear Evento" action="#{agendaRestManagedBean.crearEvento()}" />
                <h:commandButton id="Validar" value="Validar" action="#{agendaRestManagedBean.verEventosSinValidar()}" rendered="#{agendaRestManagedBean.usuarioSeleccionado.tipoUsuario == 3}"/>
                
            </h:form>
        </f:view>
<br/><br/><br/>
mapa
<br/><br/>
        <div id="map"></div>
        
         <script>
                var map;
                function initMap() {
                    var map = new google.maps.Map(document.getElementById('map'), {
                  center: {lat: 36.714835, lng: -4.475434},
                  zoom: 12
                });
                var infoWindow = new google.maps.InfoWindow({map: map});

                if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                    };

                    infoWindow.setPosition(pos);
                    infoWindow.setContent('Location found.');
                    map.setCenter(pos);
                  }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                  });
                } else {
                  // Browser doesn't support Geolocation
                  handleLocationError(false, infoWindow, map.getCenter());
                }
                
                
            // obtener latitudes y longitudes
            latEvents  = document.getElementsByClassName("latitud");
            longEvents = document.getElementsByClassName("longitud");
            var limite = latEvents.length;
            for (var i=0; i<limite; i++){
                var uluru = {lat: latEvents[i].innerHTML, lng: longEvents[i].innerHTML};

                var marker = new google.maps.Marker({
                    position: uluru,
                    map: map
                    });       
            }
            }
              function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                                      'Error: The Geolocation service failed.' :
                                      'Error: Your browser doesn\'t support geolocation.');
              }                  
                  
                
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAJa3JCM3O5-HOrUclCF9tRVEIF53WDbwM&amp;callback=initMap">
        </script>
        <br/> 
        

    </h:body>
</html> 